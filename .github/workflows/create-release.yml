name: Create a versioned release

on:
  push:
    tags:
      - "v[0-9]+.*"

  workflow_dispatch: # trigger manually
    inputs:
      cli_version:
        description: "FastEdge cli version"
        required: true
        default: "latest"
      tag_version:
        description: "Release tag e.g. v1.0.1"
        required: true
        default: ""

permissions:
  contents: write # Required to create releases and push tags

jobs:
  check_tags:
    # runs-on: [self-hosted, ubuntu-22-04, regular]
    runs-on: ubuntu-latest
    outputs:
      has_release_tag: ${{ steps.determine-tag.outputs.has_tag }}

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v6

      - name: Validate release tag
        id: determine-tag
        run: |
          if [ -n "${{ github.event.inputs.tag_version }}" ]; then
            TAG_VERSION="${{ github.event.inputs.tag_version }}"
          else
            TAG_VERSION=${GITHUB_REF#refs/tags/}
          fi
          if [[ ! "$TAG_VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[0-9]+)?$ ]]; then
            echo "Invalid tag format: $TAG_VERSION"
            exit 1
          fi
          echo "has_tag=true" >> $GITHUB_OUTPUT
          echo "Determined release tag: $TAG_VERSION"

  test_release:
    # runs-on: [self-hosted, ubuntu-22-04, regular]
    needs: [check_tags]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v6

      - name: Setup Node Environment
        uses: ./.github/setup-node

      - name: Setup FastEdge Run CLI (Linux x64)
        uses: ./.github/setup-fastedge-cli
        with:
          cli_version: ${{ inputs.cli_version }}
          github_token: ${{ github.token }}

      - name: Build (including WASM test apps)
        run: |
          pnpm run build:ci-test

      - name: Run tests
        run: |
          pnpm test

  # fossa:
  #   uses: ./.github/workflows/fossa.yaml
  #   needs: [test_release]
  #   secrets:
  #     FOSSA_PUB_API_KEY: ${{ secrets.FOSSA_PUB_API_KEY }}

  download_fastedge_cli:
    uses: ./.github/workflows/download-cli.yml
    needs: [test_release]
    if: ${{ needs.check_tags.outputs.has_release_tag == 'true' }}
    with:
      cli_version: ${{ inputs.cli_version }}

  build_debugger:
    # needs: ["fossa", "check_tags", "download_fastedge_cli"]
    needs: ["test_release", "download_fastedge_cli"]
    if: ${{ needs.check_tags.outputs.has_release_tag == 'true' }}
    # runs-on: [self-hosted, ubuntu-22-04, regular]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v6

      - name: Setup Node Environment
        uses: ./.github/setup-node

      - name: Download all CLI artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: fastedge-run-*-artifact
          path: cli-artifacts
          merge-multiple: false

      - name: Merge macOS and Windows binaries into fastedge-run/
        run: |
          # Linux binary already set up by setup-fastedge-cli action
          find cli-artifacts -type f -name 'fastedge-run-darwin-arm64' -exec cp {} fastedge-run/ \;
          find cli-artifacts -type f -name 'fastedge-run.exe' -exec cp {} fastedge-run/ \;
          # Copy METADATA.json from any artifact (they're all the same)
          find cli-artifacts -type f -name 'METADATA.json' -exec cp {} fastedge-run/ \; -quit

          # Restore execute permissions (GitHub Actions artifacts strip execute bits)
          chmod +x fastedge-run/fastedge-run-darwin-arm64
          chmod +x fastedge-run/fastedge-run-linux-x64
          echo "✅ Execute permissions set"

          # Verify all platform binaries exist
          echo "Verifying CLI binaries..."
          ls -lh fastedge-run/
          test -f fastedge-run/fastedge-run-linux-x64 || { echo "Missing Linux binary"; exit 1; }
          test -f fastedge-run/fastedge-run-darwin-arm64 || { echo "Missing macOS binary"; exit 1; }
          test -f fastedge-run/fastedge-run.exe || { echo "Missing Windows binary"; exit 1; }
          echo "✅ All platform binaries present"

      - name: Build Debugger code
        run: |
          pnpm run build

      - name: Zip Debugger distribution
        run: |
          mkdir -p release
          zip -r release/fastedge-debugger.zip dist

      - name: Create SHA256 checksum
        run: |
          cd release
          # Create checksum without path prefix (just filename)
          shasum -a 256 fastedge-debugger.zip > fastedge-debugger.zip.sha256
          cd ..
          echo "ASSET=release/fastedge-debugger.zip" >> $GITHUB_ENV
          echo "ASSET_SUM=release/fastedge-debugger.zip.sha256" >> $GITHUB_ENV

      - name: Upload release archive
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag_version || github.ref_name }}
          files: |
            ${{ env.ASSET }}
            ${{ env.ASSET_SUM }}
